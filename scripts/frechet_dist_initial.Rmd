---
title: "Frechet distance between curves and curve-based descriptive statistics"
author: "Ali"
date: "21/01/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is inspired by the following paper.
[Jonas L. Juul, et al paper](https://www.nature.com/articles/s41567-020-01121-y#Fig2)
Fixed-time descriptive statistics underestimate extremes of epidemic curve ensembles
Jonas L. Juul, Kaare Græsbøll, Lasse Engbo Christiansen & Sune Lehmann 
Nature Physics volume 17, pages5–8(2021)

in Juul's paper, pitfalls of fixed-time mean trajectory (the pointwise mean at each time step) is explored and an alternative curve-based method, which is based on ranking the curves and sampling, is studied.

Juul: there are different ways one can rank the centrality of curves;

- all-or-nothing ranking method (Fig.2b,c)
- weighted ranking (Fig.2d)
- one can rank the curves according to some feature of interest (Fig.2e), where the median projected peak value received the highest centrality.
  
Ali: Our approach is Frechet distance (see below)
  
- suppose we have a set of trajectories.
- Frechet distance between the trajectories to be calculated,
- the distribution of the distances can be estimated, 
- the curve-based descriptive statistics can be [?] as follows 
  (1) ranking the curves from more central (closer to the distribution mean/median I propose) to less central
  (2) Plot the envelope containing the most central curves.



## Frechet Distancing 
```{r packages, echo=FALSE, message=FALSE}
library(tidyverse)
library(directlabels)
library(SimilarityMeasures)
library(rethinking)
```


```{r simple examples, echo= FALSE}
# Creating two trajectories.
path1 <- matrix(c(0, 1, 2, 3, 0, 1, 2, 3), 4)
path2 <- matrix(c(0, 1, 2, 3, 4, 5, 6, 7), 4)
# plot(path2)
# Running the Frechet distance algorithm.
Frechet(path1, path2)
```

```{r simple example 2}
n_sample <- 10 ## num of data points, days
n_traj <- 20 ## number of trajectories
t <- 1:n_sample

set.seed(1234)
M <- matrix(data=NA,nrow=n_sample,ncol=n_traj)
M <- replicate(n_traj,rnorm(n_sample,mean = n_sample/2))

## Fixed-time mean; the pointwise mean at each time step
matplot(x=t,y=M,type = "l", pch = 3, col = "grey")
lines(t,rowMeans(M), col = "red", lwd = 2)


# calc the Frechet dist between trajectores in M and store in dist dataframe
df_dist <-data.frame(id=factor(),dist=integer())

for(i in 1:(n_traj-1)){
  temp_traj1 <- matrix(data=NA,nrow=n_sample,ncol=2)
  temp_traj2 <- matrix(data=NA,nrow=n_sample,ncol=2)
  temp_traj1[,1] <- t
  temp_traj1[,2] <- M[,i]
  temp_traj2[,1] <- t
  temp_traj2[,2] <- M[,i+1]
  
  iid <- paste("tr",i,"tr",i+1,sep = "_")
  ddist <- Frechet(temp_traj1, temp_traj2)
  # Frechet dist
  df_dist <- rbind(df_dist,
                   data.frame(id=iid,dist=ddist)
                   ) 
    
}

# density plot of the Frechet dist
dens(df_dist$dist)

```
## Ranking the centrality of curves following the Frechet distance method

```{r ranking}

m <- mean(df_dist$dist) ## could be median?

df_dist <- ( df_dist
  %>% mutate(delta = abs(dist-m))
) 

df_dist <- dplyr::arrange(df_dist,(delta)) %>% mutate(rank = 1: nrow(df_dist))

## the rank =1 is referring to trajectories 14 and 15 [? how to pick the trajectory]
matplot(x=t,y=M,type = "l", pch = 3, col = "grey") +
lines(t,rowMeans(M), col = "red", lwd = 2) +
lines(t,M[,14], col = "blue", lwd = 2) 
legend("topright", legend = c("grey:tajectories", "red:fixed-time mean","blue:Frechet mean"),
         col= c("grey","red", "blue"))       
       
## FIXME: the legend 


```



